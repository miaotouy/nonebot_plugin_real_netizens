## AI 虚拟群友框架 - 总体架构（更新版）
**一、目标**
打造一个基于 LLM 的 AI 虚拟群友框架，使其能够：
* 模拟真实群友的聊天行为，包括主动参与话题、发表观点、回复消息等。
* 根据不同的角色设定，展现不同的性格、兴趣和行为模式。
* 与用户建立长期联系，记住之前的对话内容和用户偏好。
* 不断学习和进化，提高聊天质量和用户体验。
**二、架构设计**
1.  **模块划分**
    框架采用模块化设计，主要分为以下模块：
    *   **\_\_init\_\_.py:** 插件入口，负责初始化和加载各个模块。
    *   **main.py:** 主模块，整合各个功能模块，处理消息事件和定时任务。
    *   **config.py:** 配置模块，定义配置项和默认值，加载外部配置文件 (.env)。
        *   读取管理员 QQ 号，用于权限控制。
        *   定义预设、世界书和角色卡的默认值。
        *   读取自定义资源文件路径。
    *   **event\_listener.py:** 事件监听器，负责监听群聊消息事件，并将事件传递给主模块处理。
    *   **message\_processor.py:** 消息处理模块，解析消息内容，提取关键词和语义信息。
    *   **trigger\_manager.py:** 触发管理模块，根据预设的规则和条件判断是否触发 AI 回复。
    *   **llm\_judge.py:** 回复判断模块，利用 LLM 模拟角色思考过程，判断是否需要回复消息。
    *   **memory\_manager.py:** 记忆管理模块，存储和管理聊天历史、用户信息、世界信息等。
    *   **behavior\_engine.py:** 行为决策模块，根据上下文、记忆和角色设定，决定 AI 的行为。
    *   **message\_sender.py:** 消息发送模块，将 AI 生成的回复发送到群聊。
    *   **group\_config\_manager.py:** 群配置管理模块，管理每个群的特定配置：
        *   角色卡设置。
        *   启用的预设。
        *   启用的世界书（可叠加）。
    *   **character\_manager.py:** 角色卡管理模块，加载和管理角色卡信息，支持热加载。
        *   从指定路径读取角色卡文件。
    *   **world\_info\_manager.py:** 世界信息管理模块，加载和管理世界书信息，支持热加载。
        *   从指定路径读取世界书文件。
    *   **preset\_manager.py:** 预设管理模块，加载和管理预设文件，支持热加载。
        *   从指定路径读取预设文件。
    *   **resource\_loader.py:** 资源加载器，负责加载预设、世界书、角色卡等资源文件，并支持热加载功能。
    *   **plugin\_manager.py:** 插件管理器，管理插件设置，并提供热加载插件的机制。
    *   **message\_builder.py:** 消息构建模块，根据预设文件、世界信息和角色卡信息构建发送给 LLM 的消息。
    *   **llm\_generator.py:** LLM API 调用模块，负责与 LLM 服务交互，发送请求和接收响应。
    *   **logger.py:** 日志记录器，负责记录框架运行过程中的日志信息，方便调试和问题排查。
2.  **数据流**
    *   **消息接收:** 接收来自用户的群聊消息。
    *   **管理员指令处理:**
        *   解析管理员指令，例如查看文件列表、选择预设、世界书或角色卡。
        *   更新群配置。
        *   触发资源加载器重新加载资源。
    *   **消息处理:** 解析消息内容，提取关键词和语义信息。
    *   **触发检查:** 判断消息是否满足触发条件。
    *   **回复判断:** 利用 LLM 和角色设定判断是否需要回复。
    *   **记忆检索:** 从数据库中检索相关的聊天历史、用户信息、世界信息等。
    *   **行为决策:** 根据上下文、记忆和角色设定，决定 AI 的行为。
    *   **消息构建:** 根据预设文件、世界信息和角色卡信息构建发送给 LLM 的消息。
    *   **LLM 调用:** 将构建好的消息发送给 LLM，并接收回复。
    *   **回复处理:** 对 LLM 的回复进行处理，例如格式化、添加表情等。
    *   **消息发送:** 将最终的回复发送到群聊。
    *   **记忆更新:** 将新的消息和相关信息存储到数据库中，更新记忆。
    *   **热加载处理:** 在资源加载器或插件管理器检测到文件更新时，触发热加载逻辑，更新相应的资源或插件设置。
3.  **数据库设计**
    数据库用于存储和管理群聊数据，包括：
    *   **User 表:** 存储用户信息，包括 QQ 号、昵称、头像等。
    *   **Group 表:** 存储群组信息，包括群号、群名称等。
    *   **GroupUser 表:** 存储用户在群组中的信息，例如群昵称、加入时间、角色等。
    *   **Message 表:** 存储消息信息，包括发送者、群组、内容、时间等。
    *   **GroupConfig 表:** 存储每个群组的特定配置，例如角色、预设、世界信息等。
**四、核心功能**
*   **多角色支持:** 可以为不同的群组设置不同的角色，每个角色有其独特的性格、兴趣和行为模式。
*   **上下文感知:**  能够理解和记忆之前的对话内容，并在回复中体现出来。
*   **世界信息整合:** 可以加载和使用世界书信息，使 AI 的回复更加符合世界观设定，支持多世界书叠加。
*   **预设文件解析:** 可以解析酒馆预设文件，并根据预设构建发送给 LLM 的消息。
*   **图片处理:** 能够识别图片内容，并将其转化为文本描述，方便 AI 理解和使用。
*   **可配置化:** 提供丰富的配置选项，例如触发条件、模型参数、角色设定等。
*   **热加载:** 支持热加载预设、世界书、角色卡和插件设置。
*   **重载指令:**  允许管理员通过指令消息查看、选择和启用/禁用预设、世界书和角色卡。
*   **默认值:**  在没有设置的情况下，预设、世界书和角色卡有默认值。
**五、设计细节**
*   **管理员指令:**  定义管理员指令格式，例如：
    *   `预设列表`：查看可用预设列表。
    *   `预设 <preset_name>`：切换预设。
    *   `世界书列表`：查看可用世界书列表。
    *   `世界书启用 <worldbook_name>`：启用世界书。
    *   `世界书禁用 <worldbook_name>`：禁用世界书。
    *   `角色卡 <group_id> <character_name>`：设置群聊的角色卡。
    *   `指令列表`:  列出所有可用的指令
*   **文件监控:**  使用文件系统监控功能，检测资源文件变化，并自动触发热加载。
*   **错误处理:**  在各个模块中添加错误处理机制，提高框架的稳定性。
*   **性能优化:** 针对消息处理、LLM 调用等关键环节进行性能优化，提升响应速度。
**六、其他建议**
*   **使用异步框架:**  使用异步框架（例如 asyncio）可以提高框架的并发处理能力，提升响应速度。
*   **使用消息队列:**  使用消息队列（例如 RabbitMQ、Kafka）可以解耦各个模块，提高框架的扩展性和可维护性。
*   **使用缓存:**  使用缓存（例如 Redis）可以提高数据访问效率，提升响应速度。
